<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Puzztory</title>
    <link rel="shortcut icon" href="http://www.puzztory.cn/static/images/favicon-mainpage.ico" />
    <link rel="bookmark" href="http://www.puzztory.cn/static/images/favicon-mainpage.ico" />

    <!-- CSS -->
    <!-- <link rel="stylesheet/less" type="text/css" href="styles.less" /> -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
        integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
    <link rel="stylesheet" href="http://www.bootcss.com/p/buttons/css/buttons.css">

    <!-- JAVASCRIPT -->
    <script src="https://code.jquery.com/jquery-3.4.1.js"
        integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
    <!-- <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous">
    </script> -->
    <script src="https://cdn.bootcss.com/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous">
    </script>
    <script src="https://cdn.bootcss.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous">
    </script>

    <style type="text/css">
        .construct-notice {
            font-size: 50px;
            text-align: center;
        }

        .side-bar-title {
            margin-top: 10px;
            font-size: 20px;
        }

        .story-list>.list-group-item {
            margin-bottom: 10px;
        }

        .frag_comment_list .list-group-item{
            margin-bottom: 10px;
            background-color:#FFF0DB;
            color: #B38952;
            padding-left: 10px;
            padding-right: 10px;
            padding-top: 0px;
            height: 30px;
        }

        .shadow {
            box-shadow: inset -3px -3px 2px #050533;
            height: 39px;
            line-height: 33px;
        }

        .shadow:active {
            line-height: 39px;
            box-shadow: inset 1px 1px 2px #050533;
            color: white;
        }
    </style>
    <script type="text/javascript">
        $(document).ready(function () {
            // 点击小火箭滚动到故事页的最上方，因为被导航条盖住了所以多滚一点
            $('#jumpTopBtn').click(function () {
                $('html, body').animate({
                    scrollTop: $("#firstCard").offset().top - 100
                }, 500);
            });

            // scroll_to_frag_id == -1 代表不需要片段滚动
            // 否则scroll_to_frag_id代表滚动到的片段id号
            {% if scroll_to_type_id != -1 %}
            $('html, body').scrollTop($("#{{ scroll_to_type_id }}").offset().top - 200);
            // $('html, body').animate({
            //         scrollTop: $("#{{ scroll_to_type_id }}").offset().top - 100
            //     }, 500);
            {% endif %}
                
            // 尝试django生成点赞图标置换代码
            {% for frag_id in frag_like_list %}                        
            $('#{{ frag_id }}_fraglikescount').removeClass('far');
            $('#{{ frag_id }}_fraglikescount').addClass('fas');
            {% endfor %}
            // 上面是片段的这里是评论的
            {% for comment_id in comment_like_list %}                        
            $('#{{ comment_id }}_commentlikescount').removeClass('far');
            $('#{{ comment_id }}_commentlikescount').addClass('fas');
            {% endfor %}

            {% if comment_page_obj.object_list %}
            {% for comment in comment_page_obj.object_list %}
            var idx = Number({{comment_start_index}}) - Number({{forloop.counter}}) + 1
            $('#comment_{{ comment.id }} #commentIdx').html('No.' + String(idx))
            {% endfor %}
            {% endif %}
            // 当用户提交片段发现故事已经完结，跳转到故事页并弹出提交失败通知
            {% if finished_message %}
            $('#systemMessageContent').html('故事已完结，片段提交失败');
            $("#systemMessage").modal('show');
            {% endif %}

            $("#newfrag").on('input property change', function (e) {
                $("#fragWordCount").html(e.target.value.length);
                var text = this.value.trim();
                this.setCustomValidity(text.length == 0 ? "纯空格禁止" : "");
            });
            // Kal: jqeury for tooltip
            $(function () {
                $('[data-toggle="tooltip"]').tooltip()
            });

            $(".storylikescount, .fraglikescount, .commentlikescount").on('click', function(){
                {% if user.is_authenticated %}

                var id = $(this).attr('id')
                $.ajax({
                    url: "{% url 'likescount' %}",
                    data: {'id': id},
                    dataType: "JSON",
                    success: function (data){                        
                        $("#"+id).html(' '+data['count']); 
                        if(data['message']=='add'){
                            $("#"+id).removeClass('far fa-thumbs-up');
                            $("#"+id).addClass('fas fa-thumbs-up');
                        }
                        else{
                            $("#"+id).removeClass('fas fa-thumbs-up');
                            $("#"+id).addClass('far fa-thumbs-up');                            
                        }                      
                    }
                });
                {% else %}
                $("#loginRequest").modal('show');
                {% endif %}
            });

            {% if user.email == story.email %}
            $("#modifiedset").on('click', function () {
                //将判断交给后端
                $.ajax({
                    url: "{% url 'modifiedset' %}",
                    data: {
                        'story_id': {{ story.id }}
                    },
                    dataType: "JSON",
                    success: function (data) {
                        if (!data['lock']) {
                            if (data['modified']) {
                                $("#modifiedset").removeClass('btn-outline-secondary');
                                $("#modifiedset").addClass('btn-secondary');
                                $("#modifiedset").attr('title', '接续再开');
                                $("#modifiedicon").removeClass('fa-unlock-alt');
                                $("#modifiedicon").addClass('fa-lock');
                            } else {
                                $("#modifiedset").removeClass('btn-secondary');
                                $("#modifiedset").addClass('btn-outline-secondary');
                                $("#modifiedset").attr('title', '接续中止');
                                $("#modifiedicon").removeClass('fa-lock');
                                $("#modifiedicon").addClass('fa-unlock-alt');
                            }
                        } else {
                            $("#systemMessageContent").html('有读者正在修改这个故事(\'皿\')');
                            $("#systemMessage").modal('show');
                        }
                    }
                });

            }); {% endif %}

            {% if story.modified == True %}
            var timer = {};
            $("#newFragBtn").click(function () {
                // send lock message
                $('#newFragSubmitBtn').show();

                $.ajax({
                    url: "{% url 'lock' %}",
                    async: false,
                    data: {
                        'story_id': {{ story.id }}
                    },
                    dataType: "JSON",
                    success: function (data) {
                        if (!data['lock']) {
                            $('#newFragBtn').attr('data-target', '#addfrag');
                            $('#lfcontent').html('现在的尾巴: ' + data['lfcontent']);
                            // send release lock message
                            $('#submitcountdown').html(data['submitcountdown']);
                            $('#submittimelimit').html(data['submittimelimit']);

                            for (var each in timer) {
                                clearInterval(timer[each]);
                                delete timer[each];
                            }
                            var remains = data['submitcountdown'];
                            timer[remains] = setInterval(function () {
                                if (remains == 0) {
                                    clearInterval(timer[remains]);
                                    $('#newFragSubmitBtn').hide();
                                } else {
                                    remains--;
                                    $('#submitcountdown').html(remains);
                                }
                            }, 1000);
                        } else {
                            $('#systemMessageContent').html('有人正在修改这个故事(\'皿\')');
                            $('#newFragBtn').attr('data-target', '#systemMessage');
                        }
                    }
                });
            }); {% else %}
            $("#newFragBtn").click(function () {
                $.ajax({
                    url: "{% url 'lfcontent' %}",
                    data: {
                        'story_id':{{ story.id }}
                    },
                    dataType: "JSON",
                    success: function (data) {
                        $('#lfcontent').html('现在的尾巴: ' + data['lfcontent']);
                        $('#separate').hide();
                    }
                });
            }); {% endif %}

            $('#finishedSetBtn').on('click', function(){
                $('#systemMessageContent').html('确认要完结吗？（完结后不可再开）');
                $("#systemMessage").modal('show');
                $("#systemMessageExitBtn").before('\
                <button id="finishedConfirmBtn" type="button" class="btn btn-primary" data-dismiss="modal">确认</button>\
                ');
                $('#finishedConfirmBtn').on('click', function(){
                    // console.log("bind confirm successful");
                    $.ajax({
                        url: "{% url 'finishedset' %}",
                        data: {
                            'story_id': {{ story.id }}
                        },
                    });
                });
            });

            $('#deleteFragBtn').on('click', function(){
                $('#systemMessageContent').html('确认要敲除吗？（敲除后该片段将消失）');
                $("#systemMessage").modal('show');
                $("#systemMessageExitBtn").before('\
                <button id="deleteConfirmBtn" type="button" class="btn btn-primary" data-dismiss="modal">确认</button>\
                ');
                $('#deleteConfirmBtn').on('click', function(){
                    $.ajax({
                        url: "{% url 'deletefrag' lastfrag_id story.id %}",
                        
                    });
                });
            });

            // 偷懒实现：用户回复评论时会在输入栏里加上一块前缀
            $('.replyCommentBtn').on('click', function(){
                // 回复时的滚动
                $('html, body').scrollTop($("#commentscount").offset().top - 200);
                var comment_id = $(this).parent().parent().attr('id');
                // 读取正确的评论序列号
                var reply_to_index = $('#' + comment_id + ' #commentIdx').html();
                $('#commentSubmit').val('>>' + reply_to_index + ' ');
                $('#replyToCommentID').val(comment_id);
            });

            // 显示被锁消息后刷新页面
            if(('#systemMessageContent').html()!='确认要敲除吗？（敲除后该片段将消失）'){
                $('#systemMessage').on('hidden.bs.modal', function (e) {
                    // window.location.reload();
                    window.location.replace('{% url 'story_page' story.id %}');
                });
            }
            
            
            $('.commentSubmitBtn').on('click', function(){
                var form = $(this).parent().parent();
                var content = $(form).find('.content').val();
                var frag_id = $(form).find('.frag_id').val();
                $.ajax({
                    url: "{% url 'submit_frag_comment' %}",
                    data: {
                        'frag_id': frag_id,
                        'content': content,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    type: "POST",
                    dataType: "JSON",
                    success: function(data){
			            var jsonObj =  $.parseJSON(data['comment']);
                        $(form).find('.content').val('');
                        // console.log('success!');
                        // console.log(data['comment']);
			            for(var i = 0;i < jsonObj.length;i++){
			                // console.log(jsonObj[i].nickname);  //取json中的值
                            $frag_comment = 
                            '<li class="d-flex list-group-item justify-content-between" style="color:#B38952">\
                                <p>\
                                    <strong>' + jsonObj[i].nickname + '</strong>\
                                    <small style="margin-left: 10px; color:#E8A676">' + jsonObj[i].content + '</small>\
                                </p>\
                                <small>' + '刚刚发布' + '</small>\
                            </li>';
                            $('#frag_comment_' + frag_id + ' .frag_comment_list').prepend($frag_comment);
			            }
                    }
                });
            });
            
        });

        function fillFragComment(frag_id, obj){
            var comment_list = $('#frag_comment_' + frag_id + ' .frag_comment_list');
            if($(obj).hasClass('closed')){
		// alert("open");
                $(obj).addClass('opened');
                $(obj).removeClass('closed');
                $.ajax({
                    url: "{% url 'show_frag_comment' %}",
                    data: {
                        'frag_id': frag_id,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    type: "POST",
                    dataType: "JSON",
                    async: false,
                    success: function(data){
			            var jsonObj =  $.parseJSON(data['comments']);
                        // console.log('success!');
                        // console.log(data['comments']);
			            for(var i = 0;i < jsonObj.length;i++){
                            $frag_comment = 
                            '<li class="d-flex list-group-item justify-content-between" style="color:#B38952">\
                                <p>\
                                    <em>' + jsonObj[i].nickname + '</em>\
                                    <small style="margin-left: 10px; color:#E8A676">' + jsonObj[i].content + '</small>\
                                </p>\
                                <small>' + jsonObj[i].createtime + '</small>\
                            </li>';
                            comment_list.append($frag_comment);
			            }
                    }
                });
            }
            else if($(obj).hasClass('opened')){
		// alert("close");
                $(obj).addClass('closed');
                $(obj).removeClass('opened');
                comment_list.empty();
            }
        }
    </script>
</head>

<body style="background-color: rgb(248, 248, 248)">
    <nav class="navbar navbar-toggleable-md navbar-expand-sm bg-white navbar-light fixed-top">
        <div class="navbar-collapse collapse justify-content-between">
            <a class="navbar-brand" href="{% url 'index' %}">
                <img title="PuzzTory首页" alt="Logo" src="http://www.puzztory.cn/static/images/PuzzWithTitle.png"
                    style="height: 50px">
            </a>
            <ul class="navbar-nav">
                <button id="jumpTopBtn" class="btn btn-outline-warning" style="margin-right: 20px" title="回到顶部"><i class="fa fa-rocket" aria-hidden="true"></i></button>
                <form class="form-inline" action="search#TODO">
                    <div class="input-group">
                        <input type="text" class="form-control"
                            placeholder="{% if user.is_authenticated %}welcome, {{ user.userextension.nickname }}{% else %}Please login first.{% endif %}"
                            style="width: 7cm">
                        <div class="input-group-append">
                            <button class="btn btn-outline-success" type="submit"><i class="fa fa-search"
                                    aria-hidden="true"></i></button>
                        </div>
                    </div>
                </form>
                
                {% if user.email == story.email %}
                    {% if story.finished == False %}
                        <!-- modified button -->
                        {% if story.lock == True %}
                        <button class="btn btn-danger disabled" title="正在续写" style="margin-left:20px"><i class="fas fa-user-lock"></i></button>
                        {% elif story.modified == True %}
                        <button id="modifiedset" class="btn btn-outline-secondary" title="续写禁止" style="margin-left:20px"><i class="fas fa-user-shield"></i></button>
                        {% else %}
                        <button id="modifiedset" class="btn btn-secondary" title="续写再开" style="margin-left:20px"><i class="fas fa-user-shield"></i></button>
                        {% endif %}
                        <!-- finished button -->
                        <button id="finishedSetBtn" class="btn btn-outline-secondary" title="故事完结" style="margin-left:20px"><i class="fa fa-hourglass-end" aria-hidden="true"></i></button>
                    {% else %}
                    <button id="finishedSign" class="btn btn-secondary" title="故事已完结" style="margin-left:20px" disabled><i class="fa fa-hourglass-end" aria-hidden="true"></i></button>
                    {% endif %}
                {% endif %}
            </ul>
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" {% if user.is_authenticated %}
                        href="{% url 'upload_story_page' %}" {% else %} data-toggle="modal" data-target="#loginRequest"
                        {% endif %}><i title="发布故事" class="fas fa-plus"></i></a></li>
                <li class="nav-item"><a class="nav-link" {% if user.is_authenticated %}href="{% url 'system_message' %}"
                        {% else %} data-toggle="modal" data-target="#loginRequest" {% endif %}><i title="系统通知"
                            class="fas fa-bell"></i></a></li>
                {% if not user.is_authenticated %}
                <li class="nav-item"><a class="nav-link" href="{% url 'login_page' %}"><i title="登录/注册"
                            class="fas fa-user"></i></a>
                </li>
                {% else %}
                <li class="nav-item"><a class="nav-link" href="{% url 'user_page' user.userextension.nickname %}"><i
                            title="个人主页" class="fas fa-user"></i></a>
                </li>
                <li class="nav-item"><a class="nav-link" href="#" data-toggle="modal" data-target="#logoutWindow"><i
                            title="退出登录" class="fas fa-sign-in-alt"></i></a>
                </li>
                {% endif %}
            </ul>
        </div>
    </nav>
    <!-- LOGOUT WINDOW -->
    <div class="modal fade" id="logoutWindow" tabindex="-1" role="dialog" aria-labelledby="logoutMessage"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logoutMessage">通知 ('/_ ') </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    确定要退出吗？
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">返回</button>
                    <a href="{% url 'logout' %}"><button type="button" class="btn btn-primary">退出</button></a>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIN REQUEST -->
    {% if not user.is_authenticated %}
    <div class="modal fade" id="loginRequest" tabindex="-1" role="dialog" aria-labelledby="loginRequestLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginRequestLabel">通知 ('/_ ') </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    请先登录
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">返回</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}


    <div class="container-fluid " style="background-color: rgb(248, 248, 248)">
        <div class="row justify-content-center" style="padding-top:70px;margin: 20px">
            <!-- <div class="col-1"></div> -->
            <div class="card col-sm-8" id="firstCard"
                style="background-color:rgb(246, 255, 238); padding:20px; margin-top:30px">

                <div class="row" style="padding-left: 10px; padding-right: 10px; padding-top:7px">
                    <div class="col-md-auto align-self-center" style="padding-left: 5px">
                        {% if story.finished == True %}
                        <i class="fa fa-hourglass-end" style="font-size: 17px" aria-hidden="true" title="finished"></i>
                        <!-- if the story can be modified -->
                        {% elif story.modified == False %}
                        <i id="modifiedicon" class="fa fa-lock" style="font-size: 17px" aria-hidden="true"
                            title="this story can only be modified by initiator"></i>
                        <!-- if the story is being edited -->
                        {% elif story.lock == True %}
                        <i class="fa fa-pen-alt" style="font-size: 17px" aria-hidden="true" title="being edited"></i>
                        {% else %}
                        <i id="modifiedicon" class="fa fa-unlock-alt" style="font-size: 17px" aria-hidden="true"
                            title="you can write now"></i>
                        {% endif %}
                    </div>
                    <div class="align-self-center">
                        <h4 style="margin-bottom: 0px; padding-left: 0px">{{ story.title }}</h4>
                    </div>
                    <div class="col-md-auto ml-auto align-self-center">
                        <div class="badge" style="font-size: 17px; color: rgb(153, 163, 146)">R</div>
                        <div class="badge" style="font-size: 17px; color: rgb(153, 163, 146)">K</div>


                        <!-- TODO: add if statement after storytable has attribute 'rules' -->
                        <!-- <div class="badge badge-light mr-1">R</div> -->
                        <!-- TODO: add if statement after storytable has attribute 'keywords' -->
                        <!-- <div class="badge badge-light mr-1">K</div> -->

                        {% if story.fragscountlimit != -1 or story.fragwordslimit != -1 %}
                        <div class="badge" style="font-size: 17px; color: rgb(153, 163, 146)">F</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row">
                    <p style="margin: 15px; white-space: pre-wrap">{{ story.ffcontent }}</p>
                </div>

                {% if story.fragscountlimit != -1 %}
                <div class="progress" style="margin-top: 20px; margin-bottom: 10px">
                    <div class="progress-bar" role="progressbar"
                        style="background-color:cadetblue; width: {% widthratio story.fragscount story.fragscountlimit 100 %}%"
                        aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
                        {{ story.fragscount }}/{{ story.fragscountlimit }}</div>
                </div>
                {% endif %}

                <div class="row" style="margin-bottom: 7px">
                    <div class="col-md-auto align-self-center">
                        <i class="far fa-user" style="font-size: 12px"> {{ story.nickname }} </i>
                    </div>
                    <div class="col-md-auto align-self-center">
                        <i class="far fa-clock" style="font-size: 12px"> {{ story.createtime }} </i>
                    </div>

                    <div class="col-md-auto ml-auto align-self-center">
                        {% if story_like == 'false' %}
                        <i id="{{ story.id }}_storylikescount" class="far fa-thumbs-up storylikescount" style="font-size: 12px; margin-right:10px"> {{ story.likescount }}</i>
                        {% else %}
                        <i id="{{ story.id }}_storylikescount" class="fas fa-thumbs-up storylikescount" style="font-size: 12px; margin-right:10px"> {{ story.likescount }}</i>
                        {% endif %}
                        <i class="far fa-comment" style="font-size: 12px"> {{ story.commentscount }} </i>
                    </div>
                </div>
                <div>
                    <span><small class="text-muted">keyword1 </small></span>
                    <span><small class="text-muted">keyword2 </small></span>
                </div>
            </div>

        </div>

        <div class="row justify-content-center" style="margin:20px;">
            <ul class="list-group col-sm-8" style="padding:0px">
                {% if page_obj.object_list %}
                {% for frag in page_obj.object_list %}
                {% if frag.id != story.ffid %}
                <div class="list-group-item" id="frag_{{ frag.id }}"
                    style="background-color: rgb(248, 248, 248); margin-bottom:20px; padding:0px;">
                    <div class="card" style="border:0px; background-color: rgb(255, 251, 234);">
                        <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-puzzle-piece"></i></h5>
                            <p class="card-text" style="white-space: pre-wrap">{{ frag.content }}</p>
                            <div class="row" style="margin-bottom: 7px; margin-top: 20px">
                                <div class="col-md-auto align-self-center">
                                    <i class="far fa-user" style="font-size: 12px"> {{ frag.nickname }} </i>
                                </div>
                                <div class="col-md-auto align-self-center">
                                    <i class="far fa-clock" style="font-size: 12px"> {{ frag.createtime }}</i>
                                </div>

                                <div class="col-md-auto ml-auto align-self-center">
                                    {% if frag.id == lastfrag_id %}
                                    {% if user.email == story.email or user.email == frag.email %}
                                    <a id="deleteFragBtn"
                                        class="fas fa-hammer"
                                        style="font-size: 12px; margin-right:10px; color:rgb(48, 48, 48); text-decoration: none"
                                        title="敲除"></a>
                                    {% endif %}
                                    {% endif %}
                                    
                                    
                                    <i id="{{ frag.id }}_fraglikescount" type="number" class="far fa-thumbs-up fraglikescount" style="font-size: 12px; margin-right:10px">
                                        {{ frag.likescount }}</i>
                                    
                                    <i class="far fa-comment closed" style="font-size: 12px" data-toggle="collapse"
                                    href="#frag_comment_{{ frag.id }}" onclick="fillFragComment('{{ frag.id }}', this)"> {{ frag.commentscount }}</i>
                                </div>
                            </div>
                        </div>
                        <div class="row justify-content-center"
                            style="background-color:rgb(255, 207, 144); margin: 0px; padding-top: 15px">
                            <div class="col-sm-10">
                                <div class="collapse" id="frag_comment_{{ frag.id }}">
                                    <form class="fragCommentForm">
                                        <div class="input-group input-group-sm mb-3">
                                            <input type="text" class="form-control content"
                                                placeholder="在此输入你的评论...（小于150字，不支持换行）">
                                            <input type="hidden" class="frag_id" value="{{ frag.id }}">
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-light commentSubmitBtn" type="button">
                                                    <i class="fa fa-plane" aria-hidden="true">发送</i></button>
                                            </div>
                                        </div>
                                    </form>
                                    <ul class="list-group frag_comment_list">
                                        <!-- <li class="d-flex list-group-item justify-content-between">
                                            <p>
                                                <em>edwardchen</em>
                                                <small style="margin-left: 10px; color:#E8A676">content</small>
                                            </p>
                                            <small>createtime</small>
                                        </li> -->
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
                {% endif %}

            </ul>
        </div>

        <div class="row justify-content-center" style="padding-bottom:90px;">
            {% if not user.is_authenticated %}
            <button type="button" class="btn btn-outline-info disabled" data-toggle="modal"
                data-target="#loginRequest"><i class="fas fa-feather-alt"> 添加一个新片段 </i></button>
            {% elif story.lock == True and story.editor != user.email %}
            <button type="button" class="btn btn-outline-info disabled" data-toggle="tooltip" data-placement="top"
                title="有人正在修改这个故事"><i class="fas fa-feather-alt"> 添加一个新片段 </i></button>
            {% elif story.modified == False and user.email != story.email %}
            <button type="button" class="btn btn-outline-info disabled" data-toggle="tooltip" data-placement="top"
                title="作者禁止了对这个故事的修改"><i class="fas fa-feather-alt"> 添加一个新片段 </i></button>
            {% elif story.finished == True %}
            <button type="button" class="btn btn-outline-info disabled" data-toggle="tooltip" data-placement="top"
                title="完结撒花"><i class="fas fa-feather-alt"> 添加一个新片段 </i></button>
            {% elif story.fragscount == story.fragscountlimit %}
            <button type="button" class="btn btn-outline-info disabled" data-toggle="tooltip" data-placement="top"
                title="这个故事已经塞不下了"><i class="fas fa-feather-alt"> 添加一个新片段 </i></button>
            {% else %}
            <button type="button" id="newFragBtn" class="btn btn-outline-info" data-toggle="modal"
                data-target="#addfrag"><i class="fas fa-feather-alt"> 添加一个新片段 </i></button>
            {% endif %}
            
            <div class="modal fade" id="systemMessage" tabindex="-1" role="dialog" aria-labelledby="systemMessageLabel"
                aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="systemMessageLabel">通知 ('/_ ') </h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body" id="systemMessageContent">
                            有人正在修改这个故事('皿')
                        </div>
                        <div class="modal-footer">
                            <button id="systemMessageExitBtn" type="button" class="btn btn-danger" data-dismiss="modal">返回</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal fade" id="addfrag" tabindex="-1" role="dialog" aria-labelledby="addfragLabel"
                aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header" style="border:0px; padding-bottom: 0px">
                            <h5 class="modal-title" id="uploadFragWindow">你的脑洞 ('/_ ') </h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body" style="height: 400px">

                            <form action="{% url 'upload_frag' story.id %}" method="POST">
                                {% csrf_token %}
                                <p id="lfcontent"></p>
                                <div class="form-group" style="margin-bottom: 0px">
                                    <textarea id="newfrag" class="form-control" placeholder="在此输入你想新增的片段内容"
                                        style="height: 265px"
                                        maxlength="{% if story.fragwordslimit != -1 %}{{ story.fragwordslimit }}{% else %}500{% endif %}"
                                        name="fcontent" required></textarea>
                                </div>
                                <span class="row text-muted" style="margin-right: 10px; margin-left: 5px">
                                    <small type="number" id="submitcountdown" style="color:brown"></small><small
                                        id="separate" style="color:brown">/</small><small id="submittimelimit"
                                        style="color:brown"></small>
                                    <small class="ml-auto" id="fragWordCount">0</small><small
                                        id="fragWordLimit">/{% if story.fragwordslimit != -1 %}{{ story.fragwordslimit }}{% else %}500{% endif %}</small>
                                </span>
                                <div class="form-row justify-content-end" style="margin-top: 10px">
                                    <button type="button" class="btn btn-secondary" style="margin-right:5px"
                                        data-dismiss="modal">取消</button>
                                    <button id="newFragSubmitBtn" type="submit" class="btn btn-primary"
                                        style="margin-right:5px">提交片段</button>
                                </div>
                            </form>

                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 片段分页栏 -->
        {% if is_paginated %}
        <div class="row justify-content-center" style="padding-bottom:30px;">
            <nav aria-label="Page navigation example">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}" tabindex="-1"><i
                                class="fa fa-angle-left" aria-hidden="true"></i></a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <a class="page-link" tabindex="-1"><i class="fa fa-angle-left" aria-hidden="true"></i></a>
                    </li>
                    {% endif %}

                    {% for i in paginator.page_range %}
                    {% if i == frag_page_bound.left or i == frag_page_bound.right %}
                    <li class="page-item disabled"><a class="page-link">...</a></li>
                    {% elif page_obj.number == i %}
                    <li class="page-item active"><a class="page-link">{{i}}</a></li>
                    {% elif i > frag_page_bound.left and i < frag_page_bound.right %}
                    <li class="page-item"><a class="page-link" href="?page={{ i }}">{{i}}</a></li>
                    {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}"><i class="fa fa-angle-right"
                                aria-hidden="true"></i></a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <a class="page-link" tabindex="-1"><i class="fa fa-angle-right" aria-hidden="true"></i></a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>

        <div class="row justify-content-center" style="padding-bottom: 30px;">
            <div class="col-sm-8">
                <p><strong id="commentscount">{{ story.commentscount }}</strong>评论</p>
                <!-- NOTE: form-control! 好用！ -->
                <hr>
                <form id="commentForm" action="{% url 'submit_comment' story.id page_obj.number %}" method="POST">
                    {% csrf_token %}
                    <div class="input-group mb-3">
                        <textarea class="form-control" type="text" name="content" id="commentSubmit" rows="3" placeholder="在此输入你的评论（小于等于150字）..." maxlength="150" required></textarea>
                        <div class="input-group-append">
                            <button class="btn btn-info" type="submit" id="submitCommentBtn">发表评论</button>
                        </div>
                    </div>
                    <input type="hidden" name="replyToCommentID" id="replyToCommentID">
                </form>
                <hr>
                {% if comment_is_paginated %}
                <nav aria-label="Page navigation example" style="margin-top: 20px">
                    <ul class="pagination pagination-sm justify-content-end">
                        {% for i in comment_paginator.page_range%}
                            {% if i == comment_page_bound.left or i == comment_page_bound.right %}
                            <li class="page-item disabled"><a class="page-link">...</a></li>
                            {% elif comment_page_obj.number == i %}
                            <li class="page-item active">
                              <a class="page-link" tabindex="-1">{{i}}</a>
                            </li>
                            {% elif i > comment_page_bound.left and i < comment_page_bound.right %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.number }}&comment_page={{ i }}" tabindex="-1">{{i}}</a>
                            </li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                  </nav>
                {% endif %}
                <div class="list-group">
                    {% if comment_page_obj.object_list %}
                    {% for comment in comment_page_obj.object_list %}
                    <a class="list-group-item list-group-item-action flex-column align-items-start" id="comment_{{ comment.id }}">
                        <div class="d-flex w-100 align-items-center justify-content-between">
                            <h5 class="mb-1"> <i class="fa fa-user-circle" aria-hidden="true"></i>
                                {{ comment.nickname }}</h5>
                            <small style="margin-left: 10px" id="commentIdx">施工中</small>
                        </div>
                        <p class="mb-1" style="white-space: pre-wrap">{{ comment.content }}</p>
                        <p class="mb-1">
                            <small style="padding-right: 10px">{{ comment.createtime }}</small>
                            <i id="{{ comment.id }}_commentlikescount" class="far fa-thumbs-up commentlikescount" aria-hidden="true" style="padding-right: 5px"> {{ comment.likescount }}</i>
                            <!-- <small style="padding-right: 10px">{{ comment.likescount }}</small> -->
                            <i class="far fa-thumbs-down" aria-hidden="true" style="padding-right: 10px" title="还没做抱歉"></i>
                            <button type="button" class="btn btn-light btn-sm replyCommentBtn" style="padding: 0px">回复</button>
                        </p>

                    </a>
                    {% endfor %}
                    {% else %}
                    <a class="list-group-item list-group-item-action flex-column align-items-start">
                        <div class="d-flex w-100">
                            <h5 class="mb-1"> <i class="far fa-comment" aria-hidden="true"></i> 作者在学校一定不受欢迎吧 </h5>
                        </div>
                    </a>
                    {% endif %}
                </div>
                {% if comment_is_paginated %}
                <nav aria-label="Page navigation example" style="margin-top: 20px">
                    <ul class="pagination pagination-sm justify-content-start">
                        {% for i in comment_paginator.page_range%}
                            {% if i == comment_page_bound.left or i == comment_page_bound.right %}
                            <li class="page-item disabled"><a class="page-link">...</a></li>
                            {% elif comment_page_obj.number == i %}
                            <li class="page-item active">
                              <a class="page-link" tabindex="-1">{{i}}</a>
                            </li>
                            {% elif i > comment_page_bound.left and i < comment_page_bound.right %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.number }}&comment_page={{ i }}" tabindex="-1">{{i}}</a>
                            </li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                  </nav>
                {% endif %}
            </div>
        </div>

</body>

</html>
